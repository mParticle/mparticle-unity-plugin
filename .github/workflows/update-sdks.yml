name: "Update SDKs"

on: 
  workflow_dispatch:
    inputs:
      branch-name:
        description: "Output branch name"
        required: true
        default: "update-android-sdk"

jobs:
  update-android-sdk:
    name: "Update Android SDK"
    runs-on: ubuntu-latest
    env:
      GIT_AUTHOR_NAME: mparticle-bot
      GIT_AUTHOR_EMAIL: developers@mparticle.com
      GIT_COMMITTER_NAME: mparticle-bot
      GIT_COMMITTER_EMAIL: developers@mparticle.com
    steps:
      - name: "Download Android Maven Metadata"
        run: curl https://repo1.maven.org/maven2/com/mparticle/android-core/maven-metadata.xml -o maven-metadata.xml
      - name: "Parse Latest Version"
        id: latest-version
        uses: QwerMike/xpath-action@v1
        with:
          filename: 'maven-metadata.xml'
          expression: '//versioning/latest/text()'
      - name: "Checkout"
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          lfs: true
      - name: "Download Maven Artifact"
        id: download-maven-artifact
        uses: clausnz/github-action-download-maven-artifact@master
        with:
          url: 'https://repo1.maven.org'
          repository: 'maven2'
          groupId: 'com.mparticle'
          artifactId: 'android-core'
          version: ${{steps.latest-version.outputs.result}}
          extension: 'aar'
          # https://repo1.maven.org/maven2/com/mparticle/android-core/5.37.0/android-core-5.37.0.jar
      - name: "Output file path in container"
        run: |
          jar xf ${{steps.download-maven-artifact.outputs.file}} classes.jar
          mv -f classes.jar Assets/Plugins/Android/mparticle-core.jar
      - name: "Commit Changes"
        run: |
          git add Assets/Plugins/Android
          git diff-index --quiet HEAD || git commit -m "update: mParticle Android SDK to version ${{steps.latest-version.outputs.result}}"; git push origin HEAD:${{github.event.inputs.branch-name}}